<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Techniker Berechnungstools - MultiRecorder CSV Visu.</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <style>
        .chart-container {
            width: 100%;
            height: 60vh;
            margin: auto;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .stats {
            margin-top: 10px;
            font-size: 1rem;
            text-align: left;
            padding: 10px;
            border-top: 1px solid #ddd;
        }

        .stats p {
            margin: 1px 0;
        }

        .reset-button {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            cursor: pointer;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <header>
        Techniker Berechnungstools
    </header>

    <nav>
        <a href="index.html">Home</a>
        <a href="Stromausgang.html">Stromausgangsberechnung</a>
        <a href="Dichteberechnung.html">Dichteberechnung</a>
        <a href="Impulswertigkeit.html">Impulswertigkeit</a>
        <a href="VolumenMasse.html">Volumen-Masse-Umrechnung</a>
        <a href="Fließgeschwindigkeit.html">Fließgeschwindigkeit</a>
        <a href="Kalibrierpunkte.html">Kalibrierpunkte</a>
		<a href="Messwertabweichung.html">Messwertabweichung</a>
	    <a href="csv.html">Proline CSV-Umwandler</a>
		<a href="csvAuswertung.html">MultiRecorder CSV Visu.</a>
    </nav>

    <div class="container2">
        <h2>Lade hier die CSV-Datei aus dem Multirecorder hoch</h2>
        <input type="file" id="fileInput" accept=".csv" />
        <button id="convertButton" disabled>Start Conversion</button>

        <div class="chart-container">
            <canvas id="massFlowChart"></canvas>
            <button class="reset-button" onclick="resetZoom('massFlowChart')">Zoom zurücksetzen</button>
            <div id="massFlowStats" class="stats"></div>
        </div>
        
        <div class="chart-container">
            <canvas id="densityChart"></canvas>
            <button class="reset-button" onclick="resetZoom('densityChart')">Zoom zurücksetzen</button>
            <div id="densityStats" class="stats"></div>
        </div>
        
        <div class="chart-container">
            <canvas id="temperatureChart"></canvas>
            <button class="reset-button" onclick="resetZoom('temperatureChart')">Zoom zurücksetzen</button>
            <div id="temperatureStats" class="stats"></div>
        </div>
    </div>

    <footer class="bottom-header">
        <p><strong>Haftungsausschluss:</strong> Diese Website übernimmt keine Gewähr für die Genauigkeit oder Vollständigkeit der angezeigten Messwerte und Berechnungsergebnisse. Die Nutzung erfolgt auf eigenes Risiko.</p>
    </footer>

    <script>
        let csvData = '';

        document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        document.getElementById('convertButton').addEventListener('click', startConversion);

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    csvData = e.target.result;
                    document.getElementById('convertButton').disabled = false;
                };
                reader.readAsText(file);
            }
        }

        function startConversion() {
            if (csvData) {
                parseCSV(csvData);
            } else {
                alert("Bitte laden Sie zuerst eine CSV-Datei hoch.");
            }
        }

        function parseCSV(data) {
            try {
                const lines = data.split("\n");
                const labels = [];
                const massFlowData = [];
                const densityData = [];
                const temperatureData = [];

                lines.slice(1).forEach(line => {
                    if (line.trim() === "") return;

                    const columns = line.split(";");
                    if (columns.length < 11) {
                        console.error("Line skipped due to insufficient columns:", line);
                        return;
                    }

                    const [PCTime, , , , MassFlow, Density, , , , , Temperature] = columns;
                    const timeOnly = PCTime.split(" ")[1];
                    labels.push(timeOnly);
                    massFlowData.push(parseFloat(MassFlow));
                    densityData.push(parseFloat(Density));
                    temperatureData.push(parseFloat(Temperature));
                });

                if (massFlowData.length === 0 || densityData.length === 0 || temperatureData.length === 0) {
                    console.error("Parsed data arrays are empty.");
                    alert("Fehler: Keine gültigen Daten in der CSV gefunden. Stellen Sie sicher, dass die Spalten korrekt formatiert sind.");
                    return;
                }

                createChart("massFlowChart", "Mass Flow (kg/s)", labels, massFlowData, "massFlowStats");
                createChart("densityChart", "Density (g/l)", labels, densityData, "densityStats");
                createChart("temperatureChart", "Temperature (°C)", labels, temperatureData, "temperatureStats");

            } catch (error) {
                console.error("Error parsing CSV data:", error);
                alert("Ein Fehler trat beim Einlesen der CSV-Datei auf. Details in der Konsole.");
            }
        }

        function createChart(canvasId, label, labels, data, statsId) {
            const ctx = document.getElementById(canvasId).getContext('2d');

            if (window[canvasId] && typeof window[canvasId].destroy === 'function') {
                window[canvasId].destroy();
            }

            window[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        borderColor: 'blue',
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { display: true, title: { display: true, text: 'Time' } },
                        y: { display: true, title: { display: true, text: label } }
                    },
                    plugins: {
                        zoom: {
                            pan: { enabled: true, mode: 'xy' },
                            zoom: { drag: { enabled: true, backgroundColor: 'rgba(0, 123, 255, 0.3)' }, pinch: { enabled: true }, wheel: { enabled: true }, mode: 'xy' }
                        }
                    }
                }
            });

            displayStats(data, statsId);
        }

        function displayStats(data, statsId) {
            const max = Math.max(...data);
            const min = Math.min(...data);
            const avg = (data.reduce((a, b) => a + b, 0) / data.length).toFixed(2);
            document.getElementById(statsId).innerHTML = `<p><strong>Max:</strong> ${max} <strong>Min:</strong> ${min} <strong>Avg:</strong> ${avg}</p>`;
        }

        function resetZoom(chartId) {
            const chart = window[chartId];
            if (chart && chart.resetZoom) {
                chart.resetZoom();
            } else {
                console.warn("Reset zoom not available for", chartId);
            }
        }
    </script>
</body>
</html>
